# Decompilation Knowledge Base: mssb-dtk

This document summarizes the core patterns, compiler behaviors, and tooling insights gathered during the decompilation of the GameCube title *Mario Superstar Baseball* (GYQE01).

## 1. GCC 2.6 / PowerPC PPC Behavior Patterns

### Global Address Re-loading
The compiler often re-loads the base address of a global variable (using `lis` and `addi`) even if that address is already in a nearby register. 
*   **The Trap**: Local pointers (e.g., `Batter* b = &g_Batter;`) often cause the compiler to "hold" the address in a single register, mismatching the original.
*   **The Pattern**: Use **direct global access** (e.g., `g_Batter.field = ...;`) in distinct logical blocks to trigger a fresh load.

### Structure Assignments and Update-Form Instructions
The binary frequently uses "load/store with update" instructions (`lfsu`, `stfsu`).
*   **The Pattern**: These are often generated by structure-level assignments:
    ```c
    g_Runners[0].position = g_Batter.batterPos; // Triggers stfsu patterns
    ```
*   **Point-by-Point**: Assigning individual fields (`p.x = b.x; p.z = b.z;`) usually fails to trigger the update-form instructions.

### Register Steering ("Anchoring")
Registers `r31` and `r30` are typically used for major object base pointers.
*   **The Pattern**: Define a local pointer **at the exact line** where the assembly first allocates the base register. Defining it at the top of a function often causes the compiler to use a temporary register instead.

### ROData Ordering
Floating-point constants (literals) are stored in the `.rodata` section in the **order they are first encountered** in the C code.
*   **The Problem**: If your code uses `1.0f` before `0.0f` but the original did the reverse, their labels (`lbl_3_rodata_...`) will mismatch.
*   **The Fix**: Order your references (or dummy references) to match the assembly's order.

---

## 2. Tooling Ecosystem

### `tools/kappa_context.py`
A comprehensive context gatherer.
*   **Usage**: `python3 tools/kappa_context.py --function atBat_batter`
*   **Output**: Standardized ASM, resolved bl signatures, and data symbol locations. Use this to seed any new decompilation task.

### `tools/feedback_diff.py`
An instruction-level analyzer for iterative refinement.
*   **Usage**: `python3 tools/feedback_diff.py game/game/game_batter atBat_batter`
*   **Focus**: Identifies **Missing**, **Extra**, and **Mismatched** operands (offsets/constants) while ignoring register swaps in the early stages.

Always use feedback_diff.py to compare the decompiled code to the original assembly.

### `tools/decomp_helper.py`
Simplifies the retrieval of ASM for a given unit and symbol.

---

## 3. Best Practices for Match %
1.  **Prioritize Operands**: Fix offsets (`0x8(r3)`) and constants (`1.0f`) first.
2.  **Match Instruction Mnemonics**: Ensure `lwz` isn't compiled as `lhz` (check your struct types!).
3.  **Instruction Order**: If instructions are identical but out of order, check for sub-expression dependencies.
4.  **Casting**: Use explicit casts to match sign-extension instructions (`extsh`, `extsb`).

---

## 4. Struct Nuances
Many structs in this project use explicit padding or fixed offsets. Always refer to `include/game/UnknownHomes_Game.h` for current layout.
*   **Batter**: Base Address typically in `r31`.
*   **Pitcher**: Base Address typically in `r3`.
*   **Runners**: Array access often uses `r3` + index offset.
